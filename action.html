<?php  
    require("MySqlUtils.php");  
    header("Content-type:text/html;charset=utf-8");  
  
    $bookID = $_POST['bookNumber'];  
    $classfication = $_POST['bookClass'];  
    $bookName = $_POST['bookName'];  
    $press = $_POST['press'];  
    $publicTime = $_POST['date'];  
    $author = $_POST['author'];  
    $price = $_POST['price'];  
    $numberAll = $_POST['number'];  
  
  
    $isRightForm = checkForm();  
  
    $isRightInsert = insertBook();  
    if ($isRightInsert){  
        echo "<Script>alert('图书入库成功')</Script>";  
        echo "<Script>window.location.href='adminDoAddOneBook.php'</Script>";  
    }else{  
        echo "<Script>alert('图书入库失败,请重试!')</Script>";  
        echo "<Script>window.location.href='adminDoAddOneBook.php'</Script>";  
    }  
  
  
    function checkForm(){  
        //下面是对图书编号的合法性进行检测  
        global $bookID;  
        if ($bookID == null){  
            echo "<Script>alert('图书编号不能为空')</Script>";  
            echo "<Script>window.location.href='adminDoAddOneBook.php'</Script>";  
            return false;  
        }  
        $isRightBookID = preg_match('/[0-9]/', $bookID);  
        if (!$isRightBookID){  
            echo "<Script>alert('图书编号含有非法字符')</Script>";  
            echo "<Script>window.location.href='adminDoAddOneBook.php'</Script>";  
            return false;  
        }  
        //图书名称校验  
        global $bookName;  
        if (null == $bookName){  
            echo "<Script>alert('图书名称不能为空')</Script>";  
            echo "<Script>window.location.href='adminDoAddOneBook.php'</Script>";  
            return false;  
        }  
        //出版社  
        global $press;  
        if (null == $press){  
            echo "<Script>alert('出版社不能为空')</Script>";  
            echo "<Script>window.location.href='adminDoAddOneBook.php'</Script>";  
            return false;  
        }  
        //作者  
        global $author;  
        if (null == $author){  
            echo "<Script>alert('作者不能为空')</Script>";  
            echo "<Script>window.location.href='adminDoAddOneBook.php'</Script>";  
            return false;  
        }  
        //价格  
        global $price;  
        if (null == $price){  
            echo "<Script>alert('价格不能为空')</Script>";  
            echo "<Script>window.location.href='adminDoAddOneBook.php'</Script>";  
            return false;  
        }  
        $isRightPrice = preg_match('/[0-9]./', $price);  
        if (!$isRightPrice){  
            echo "<Script>alert('图书价格含有非法字符')</Script>";  
            echo "<Script>window.location.href='adminDoAddOneBook.php'</Script>";  
            return false;  
        }  
        //库存  
        global $numberAll;  
        if (null == $numberAll){  
            echo "<Script>alert('库存量不能为空')</Script>";  
            echo "<Script>window.location.href='adminDoAddOneBook.php'</Script>";  
            return false;  
        }  
        $isRightAllNumber = preg_match('/[0-9]/', $numberAll);  
        if (!$isRightAllNumber){  
            echo "<Script>alert('图书库存含有非法字符')</Script>";  
            echo "<Script>window.location.href='adminDoAddOneBook.php'</Script>";  
            return false;  
        }  
        return true;  
    }  
  
    function insertBook(){  
        global $bookID;  
        global $classfication;  
        global $bookName;  
        global $press;  
        global $publicTime;  
        global $author;  
        global $price;  
        global $numberAll;  
        $link = getLink();  
        if ('0' == $link){  
            echo "<Script>alert('数据库连接失败');</Script>";  
            return false;  
        }  
        $class = null;  
        if('1' == $classfication){  
            $class = '人文';  
        }else if ('2' == $classfication){  
            $class = '教辅';  
        }else if ('3' == $classfication){  
            $class = '游戏';  
        }else if ('4' == $classfication){  
            $class = '科技';  
        }else if ('5' == $classfication){  
            $class = '生活';  
        }else{  
            $class = '技术';  
        }  
        $sql = "insert into book values(".$bookID.",'".$class."',"."'".$bookName."',"."'".$press."',"."'".$publicTime."',"."'".$author."',".$price.",".$numberAll.",".$numberAll.");";  
        $isRightInsert = getResoures('libray', $sql);  
        closeConnect($link);  
        return $isRightInsert;  
    }  
?> 